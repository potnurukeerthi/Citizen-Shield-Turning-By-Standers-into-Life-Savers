<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Citizen Shield Dashboard</title>
<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<style>
body { font-family: Arial; margin: 20px; background:#f8f9fa; }
h2 { color:#222; }
#sosBtn { background:red; color:white; padding:12px 20px; border:none; border-radius:8px; cursor:pointer; font-size:18px; margin-bottom:20px; }
#map { height:400px; width:100%; margin-top:20px; border-radius:15px; }
/* The #notification div is hidden by default */
#notification { display:none; position:fixed; bottom:20px; right:20px; background:#fff; border:2px solid red; padding:15px; border-radius:10px; width:250px; box-shadow:0 0 10px rgba(0,0,0,0.3);}
#acceptBtn { background:green;color:white;margin-right:10px;padding:6px 12px;border:none;border-radius:5px; cursor:pointer;}
#declineBtn { background:gray;color:white;padding:6px 12px;border:none;border-radius:5px; cursor:pointer;}
</style>
</head>
<body>
<h2>Citizen Shield Dashboard</h2>
<p>Click SOS in emergency</p>
<button id="sosBtn">ðŸš¨ SOS</button>
<h3>Nearby Users</h3>
<div id="map"></div>

<div id="notification">
<p id="notifText"></p>
<button id="acceptBtn">Accept</button>
<button id="declineBtn">Decline</button>
</div>

<script>
const username = localStorage.getItem('currentUser');
if(!username){ alert('Login first'); location.href='login.html'; }

const emergencyEmail = localStorage.getItem(username+'_emergencyEmail');
const emergencyNumber = localStorage.getItem(username+'_emergencyNumber');
const BACKEND_URL = "https://citizen.loca.lt"; // **NOTE: Update this with your current URL**

let map, userMarker;
let otherUserMarkers = {};
let sosNotified = {};
let currentVictim = null;

// ----------------------
// Socket.IO setup
// ----------------------
const socket = io(BACKEND_URL, { forceNew: true, transports: ['websocket'] });

socket.on('connect', () => {
Â  Â  console.log("âœ… Socket connected:", socket.id);
Â  Â  socket.emit("register-user", username);
Â  Â  sendLocation(); Â  Â  Â  Â  Â // send location immediately
Â  Â  fetchNearbyUsers(); Â  Â  Â // fetch nearby users immediately
});

// ----------------------
// Initialize map
// ----------------------
navigator.geolocation.getCurrentPosition(pos=>{
Â  Â  const lat = pos.coords.latitude, lon = pos.coords.longitude;
Â  Â  map = L.map('map').setView([lat,lon],15);
Â  Â  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
Â  Â  Â  Â  attribution:'Â© OpenStreetMap contributors'
Â  Â  }).addTo(map);
Â  Â  userMarker = L.marker([lat,lon],{title:'You'}).addTo(map);
});

// ----------------------
// Send location periodically
// ----------------------
function sendLocation(){
Â  Â  navigator.geolocation.getCurrentPosition(pos=>{
Â  Â  Â  Â  const lat = pos.coords.latitude, lon = pos.coords.longitude;
Â  Â  Â  Â  if(userMarker) userMarker.setLatLng([lat,lon]);
Â  Â  Â  Â  fetch(`${BACKEND_URL}/update-location`,{
Â  Â  Â  Â  Â  Â  method:'POST',
Â  Â  Â  Â  Â  Â  headers:{'Content-Type':'application/json'},
Â  Â  Â  Â  Â  Â  body:JSON.stringify({username, lat, lon})
Â  Â  Â  Â  });
Â  Â  });
}
setInterval(sendLocation, 5000); // every 5 seconds

// ----------------------
// Fetch nearby users
// ----------------------
function fetchNearbyUsers(){
Â  Â  // 1. Get current location
Â  Â  navigator.geolocation.getCurrentPosition(pos => {
Â  Â  Â  Â  const lat = pos.coords.latitude, lon = pos.coords.longitude;
Â  Â  Â  Â  
Â  Â  Â  Â  // 2. Send location to server for filtering
Â  Â  Â  Â  fetch(`${BACKEND_URL}/nearby-users?username=${username}&lat=${lat}&lon=${lon}`)
Â  Â  Â  Â  .then(res=>res.json())
Â  Â  Â  Â  .then(users=>{
Â  Â  Â  Â  Â  Â  console.log("Nearby users:", users);
Â  Â  Â  Â  Â  Â  // Clear existing markers
Â  Â  Â  Â  Â  Â  for(let u in otherUserMarkers) otherUserMarkers[u].remove();
Â  Â  Â  Â  Â  Â  otherUserMarkers={};
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Add new markers
Â  Â  Â  Â  Â  Â  users.forEach(u=>{
Â  Â  Â  Â  Â  Â  Â  Â  if(!u.lat || !u.lon) return;
Â  Â  Â  Â  Â  Â  Â  Â  let iconUrl = u.sosActive ?
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'https://cdn-icons-png.flaticon.com/512/564/564619.png' :
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'https://cdn-icons-png.flaticon.com/512/149/149071.png';
Â  Â  Â  Â  Â  Â  Â  Â  const marker = L.marker([u.lat,u.lon],{
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title:u.username,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  icon:L.icon({iconUrl, iconSize:[30,30]})
Â  Â  Â  Â  Â  Â  Â  Â  }).addTo(map).bindPopup(`<b>${u.username}</b>${u.sosActive ? ' - ðŸš¨ SOS ACTIVE' : ''}`);
Â  Â  Â  Â  Â  Â  Â  Â  otherUserMarkers[u.username] = marker;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }).catch(console.error);
Â  Â  }, (error) => {
Â  Â  Â  Â  console.error("Could not get location for nearby fetch:", error);
Â  Â  });
}
setInterval(fetchNearbyUsers,5000);

// ----------------------
// SOS button
// ----------------------
document.getElementById('sosBtn').addEventListener('click', ()=>{
Â  Â  if(!emergencyNumber) return alert('Emergency number missing');

Â  Â  navigator.geolocation.getCurrentPosition(pos=>{
Â  Â  Â  Â  const lat = pos.coords.latitude, lon = pos.coords.longitude;
Â  Â  Â  Â  
Â  Â  Â  Â  // Corrected Map URL format
Â  Â  Â  Â  const locationUrl = `https://www.google.com/maps/search/?api=1&query=${lat},${lon}`;
Â  Â  Â  Â  const smsMessage = encodeURIComponent(`ðŸš¨ SOS! My location: ${locationUrl}`);

Â  Â  Â  Â  // 1ï¸âƒ£ Open SMS app
Â  Â  Â  Â  window.location.href = `sms:${emergencyNumber}?body=${smsMessage}`;

Â  Â  Â  Â  // 2ï¸âƒ£ Send backend request
Â  Â  Â  Â  fetch(`${BACKEND_URL}/send-sos`,{
Â  Â  Â  Â  Â  Â  method:'POST',
Â  Â  Â  Â  Â  Â  headers:{'Content-Type':'application/json'},
Â  Â  Â  Â  Â  Â  body:JSON.stringify({username, location:locationUrl})
Â  Â  Â  Â  }).then(res=>res.text()).then(console.log).catch(console.error);
Â  Â  });
});

// ----------------------
// Handle SOS alerts
// ----------------------
socket.on('sos-alert', data=>{
Â  Â  // ADDED LOG FOR DEBUGGING
    console.log("SOS Alert received:", data); 
    
Â  Â  // Only show if the victim is not the current user and we haven't notified for them yet
Â  Â  if(data.username!==username && !sosNotified[data.username]){
Â  Â  Â  Â  sosNotified[data.username]=true;
Â  Â  Â  Â  currentVictim=data.username;
Â  Â  Â  Â  document.getElementById('notifText').innerText=`ðŸš¨ ${data.username} is in danger! Help?`;
Â  Â  Â  Â  // THIS LINE MAKES THE ACCEPT/DECLINE BUTTONS VISIBLE
Â  Â  Â  Â  document.getElementById('notification').style.display='block'; 

Â  Â  Â  Â  if(Notification.permission==="granted"){
Â  Â  Â  Â  Â  Â  new Notification("SOS Alert", {
Â  Â  Â  Â  Â  Â  Â  Â  body:`${data.username} is in danger!`,
Â  Â  Â  Â  Â  Â  Â  Â  icon:'https://cdn-icons-png.flaticon.com/512/564/564619.png'
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  } else { Notification.requestPermission(); }
Â  Â  }
});

// Accept / Decline SOS
document.getElementById('acceptBtn').addEventListener('click', ()=>{
Â  Â  if(currentVictim){
Â  Â  Â  Â  socket.emit('accept-sos',{saver:username,victim:currentVictim});
Â  Â  Â  Â  document.getElementById('notification').style.display='none';
Â  Â  Â  Â  currentVictim = null; // Reset victim
Â  Â  }
});
document.getElementById('declineBtn').addEventListener('click', ()=>{
Â  Â  if(currentVictim){
Â  Â  Â  Â  socket.emit('decline-sos',{saver:username,victim:currentVictim});
Â  Â  Â  Â  document.getElementById('notification').style.display='none';
Â  Â  Â  Â  currentVictim = null; // Reset victim
Â  Â  }
});

// When user accepts SOS
socket.on('sos-accepted', data=>{
Â  Â  if(data.saver===username){
Â  Â  Â  Â  const loc=data.location;
Â  Â  Â  Â  alert(`Victim ${data.victim} location: Lat:${loc.lat}, Lon:${loc.lon}`);
Â  Â  Â  Â  // Corrected Map URL format
Â  Â  Â  Â  window.open(`https://www.google.com/maps/search/?api=1&query=${loc.lat},${loc.lon}`);
Â  Â  }
});

// When helper accepted SOS
socket.on('helper-accepted', data=>{
Â  Â  alert(`âœ… ${data.saver} accepted to help you`);
});
</script>
</body>
</html>